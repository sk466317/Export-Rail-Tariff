<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Export Rail Tariff Generator - Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body{background-color:#1f2937;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;color:#e5e7eb;zoom:90%;overflow:hidden}
        .main-wrapper{display:flex;height:100vh}
        .sidebar{width:260px;background-color:#fff;border-left:1px solid #d1d5db;overflow-y:auto;flex-shrink:0;color:#374151;box-shadow:-4px 0 15px rgba(0,0,0,0.1)}
        .content-area{flex:1;overflow-y:auto;position:relative;padding:10px}
        #login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1e3a8a 0%,#0f172a 100%);z-index:9999;display:flex;align-items:center;justify-content:center}
        .login-box{background:rgba(255,255,255,0.95);padding:2.5rem;border-radius:12px;width:100%;max-width:400px;border-top:6px solid #fb923c}
        .hidden-by-role{display:none!important}
        
        /* --- PRINT STYLES --- */
        @media print {
            @page { size: A4 landscape; margin: 5mm; }
            body { background-color: #fff !important; color: #000 !important; zoom: 100%; overflow: visible; }
            .main-wrapper { display: block; height: auto; }
            .sidebar { display: none !important; } 
            #topControls, .no-print, button { display: none !important; }
            .content-area { width: 100% !important; overflow: visible; padding: 0; }
            .page-container { box-shadow: none !important; border: none !important; width: 100% !important; margin: 0 !important; max-width: 100%; }
            .table-block { break-inside: avoid; page-break-inside: avoid; }
            .content-collapsible { display: block !important; } /* Force show content on print */
            
            input, select, textarea { border: none !important; background: transparent !important; appearance: none; color: black !important; font-weight: bold !important; }
            .tariff-table th { 
                font-size: 9px !important; 
                white-space: normal !important; 
                vertical-align: middle;
                color: black !important;
                border: 1px solid #000 !important;
                background-color: #e5e7eb !important;
            }
            .tariff-table td { border: 1px solid #000 !important; color: black !important; }
            label { color: black !important; font-size: 10px !important; font-weight: 800 !important; }
        }

        .pdf-mode{background-color:#fff!important;color:#000!important;font-family:Arial,sans-serif!important}
        .pdf-mode .no-pdf{display:none!important}
        .pdf-mode table,.pdf-mode th,.pdf-mode td,.pdf-mode input,.pdf-mode select,.pdf-mode textarea{border:0.5px solid #000!important;background:0 0!important;color:#000!important;border-radius:0!important}
        .bg-form-base{background-color:#bfdbfe}
        .tariff-table{width:100%;border-collapse:collapse;font-size:.65rem;table-layout:fixed;font-family:'Inter',sans-serif}
        .tariff-table th{border:1px solid #9ca3af;padding:6px 2px;text-align:center;font-weight:700;text-transform:uppercase;background-color:#e5e7eb;color:#000;line-height:1.1;font-size:.55rem}
        .tariff-table td{border:1px solid #9ca3af;padding:4px 2px;text-align:center;color:#000}
        .tariff-table input{width:100%;text-align:center;background:0 0;border:none;font-size:.7rem;font-weight:600;color:#000}
        
        /* SIMPLIFIED COLORS REQUEST */
        .highlight-row{background-color:#f3f4f6!important}
        .highlight-row td{border-top:1px solid #d1d5db;border-bottom:1px solid #d1d5db;color:#000}
        
        .bg-yellow-col{background-color:#fff!important} 
        .bg-teal-col{background-color:#fff!important}
        .bg-gray-col{background-color:#f9fafb;color:#000;font-weight:700}
        .bg-red-col{background-color:#fee2e2;color:#000;font-weight:900}

        .input-field{border:1px solid #4b5563;border-radius:4px;padding:4px 8px;width:100%;font-size:.75rem;background-color:#f3f4f6;color:#111827;font-weight:700}
        
        /* SIMPLIFIED READ ONLY COLOR SCHEME */
        input:disabled,select:disabled,textarea:disabled{
            background-color: #e5e7eb !important; /* Simple Gray */
            color: #000 !important;                /* Black Text */
            font-weight: 700 !important;
            border: 1px solid #9ca3af !important;
            opacity: 1 !important;
        }

        .status-valid{background-color:#bbf7d0;color:#14532d;border:2px solid #15803d}.status-expired{background-color:#fee2e2;color:#991b1b;border:2px solid #ef4444}.status-pending{background-color:#f3f4f6;color:#6b7280;border:2px solid #9ca3af}
        .status-pending-approval{background-color:#fee2e2;color:#dc2626;border:2px solid #ef4444;font-weight:bold;animation:pulse 2s infinite}
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:3000;display:flex;align-items:center;justify-content:center;flex-direction:column}
        .customer-item{cursor:pointer}
        .report-table th{position:sticky;top:0;background:#e2e8f0;color:#000;z-index:10;border:1px solid #000}
        .report-card{border:1px solid #000;border-radius:8px;margin-bottom:20px;background:#fff;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
        
        /* Approval View Specifics */
        #approvalContainer{display:none;flex-direction:column;background:#fff;padding:20px;border-radius:8px;}
        .app-table{width:100%;border-collapse:collapse;margin-bottom:20px}.app-table td{padding:8px;border:1px solid #ccc;vertical-align:middle}
        .app-label{font-weight:700;font-size:11px;text-transform:uppercase;color:#000!important}
        .app-input{width:100%;border:1px solid #999;padding:5px;font-size:12px;font-weight:700;background:#f9f9f9;color:#000!important}
        #approvalContainer .upload-section-mini,
        #approvalContainer .status-valid,
        #approvalContainer .status-expired { display: none !important; }
        #approvalContainer .tariff-table th { background-color: #e5e7eb!important; color:black!important; }
        #approvalContainer .tariff-table input { color:black!important; background:white!important; }

        /* EXPIRED TABLE STYLES */
        .expired-block {
            background-color: #fee2e2 !important; /* Red-100 */
            border: 4px solid #991b1b !important; /* Red-800 */
        }
        .expired-block th {
            background-color: #ef4444 !important; /* Red-500 */
            color: white !important;
            border-color: #7f1d1d !important;
        }
        .expired-block td {
            border-color: #ef4444 !important;
            color: #7f1d1d !important;
        }
        .expired-block input, .expired-block select, .expired-block textarea {
            color: #7f1d1d !important;
            font-weight: bold !important;
        }
        .content-hidden { display: none; }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
    <div class="login-box animate-fade-in-down">
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-blue-900 mb-4"><i class="fas fa-train text-3xl"></i></div>
            <h2 class="text-2xl font-extrabold text-blue-900">Export Rail Tariff</h2>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Select User</label>
                <select id="loginUser" class="w-full border-2 border-gray-300 rounded p-2 text-sm font-bold text-blue-900 bg-gray-50">
                    <option value="">-- Select Identity --</option>
                    <option value="ANURAG PANDEY">ANURAG PANDEY</option><option value="CHIRAG RANA">CHIRAG RANA</option><option value="MOHIK SHARMA">MOHIK SHARMA</option><option value="DAMANJIT SINGH">DAMANJIT SINGH</option><option value="HARSIMRANJEET SINGH">HARSIMRANJEET SINGH</option><option value="KUNAL SAHI">KUNAL SAHI</option><option value="RAJESH KUMAR">RAJESH KUMAR</option><option value="SUMAN KUMARI">SUMAN KUMARI</option><option value="VIKRAM SINGH">VIKRAM SINGH</option><option value="ROHIN KALRA">ROHIN KALRA</option><option value="ACCOUNTS">ACCOUNTS</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Password</label>
                <input type="password" id="loginPass" class="w-full border-2 border-gray-300 rounded p-2 text-sm font-bold text-blue-900" placeholder="Enter Password">
            </div>
            <button onclick="attemptLogin()" class="w-full bg-blue-800 hover:bg-blue-900 text-white font-bold py-3 rounded shadow uppercase text-sm">Secure Login</button>
        </div>
    </div>
</div>

<div class="main-wrapper" id="appContent" style="display: none;">
    <!-- LEFT CONTENT AREA -->
    <div class="content-area">
        
        <!-- MAIN FORM CONTAINER -->
        <div id="mainFormContainer">
            <div class="sticky top-0 z-50 max-w-[1600px] mx-auto mb-4 no-print" id="topControls">
                <div class="bg-gray-800 border-l-4 border-blue-600 p-2 rounded shadow-md">
                    <!-- Horizontal Layout Container -->
                    <div class="flex flex-wrap items-center gap-2 justify-between">
                        
                        <!-- Left Side: Search & Load -->
                        <div class="flex items-center gap-1 flex-wrap">
                            <div id="syncStatus" class="text-[10px] font-bold text-gray-300 mr-2"><i class="fas fa-circle-notch fa-spin"></i></div>
                            <input type="text" id="searchBox" placeholder="Search..." class="border rounded px-2 py-1 text-xs w-32 md:w-48 text-blue-900 font-bold" onkeyup="filterDropdown()">
                            <select id="cloudHistory" class="border rounded px-2 py-1 text-xs w-32 md:w-48 text-blue-900 font-bold bg-blue-50"><option>-- All Records --</option></select>
                            <button onclick="loadRecordFromDropdown()" class="bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold shadow hover:bg-blue-700">SHOW</button>
                            <button onclick="fetchSheetData()" class="bg-gray-600 text-white px-2 py-1 rounded text-xs font-bold shadow hover:bg-gray-700" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                            
                            <!-- NEW: Filtered Approval Dropdown in Main Form -->
                            <select id="mainApprovalHistory" class="border border-yellow-600 rounded px-2 py-1 text-xs w-32 md:w-48 text-blue-900 font-bold bg-yellow-50">
                                <option>-- Pending Approvals --</option>
                            </select>
                            <button onclick="loadMainApprovalRecord()" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs font-bold shadow hover:bg-yellow-700">SHOW</button>

                            <button onclick="toggleApprovalMode(true, true)" class="bg-yellow-400 text-black px-2 py-1 rounded text-xs font-bold border border-yellow-600 hover:bg-yellow-500 shadow"><i class="fas fa-check-double mr-1"></i> New Approval</button>
                        </div>

                        <!-- Right Side: Action Buttons -->
                        <div class="flex items-center gap-1 flex-wrap justify-end">
                            <div class="text-white text-xs font-bold flex items-center mr-1 bg-gray-700 px-2 py-1 rounded"><i class="fas fa-user-circle mr-1"></i> <span id="currentUserDisplay">User</span></div>
                            <button onclick="openReportModal()" class="bg-indigo-600 text-white px-3 py-1 rounded font-bold text-xs hover:bg-indigo-700 shadow">Reports</button>
                            <button onclick="sendEmail()" class="admin-only bg-blue-500 text-white px-3 py-1 rounded font-bold text-xs hover:bg-blue-600 shadow">Email</button>
                            <button onclick="copyToClipboard()" class="admin-only bg-teal-600 text-white px-3 py-1 rounded font-bold text-xs hover:bg-teal-700 shadow">Img</button>
			    <button onclick="downloadMainAsHTML()" class="admin-only bg-orange-500 text-white px-3 py-1 rounded font-bold text-xs hover:bg-orange-600 shadow">Download Tariff</button>
                            
                            <button id="saveBtn" onclick="saveDataToSheet('new')" class="admin-only bg-green-600 text-white px-4 py-1 rounded font-bold text-xs animate-pulse hover:bg-green-700 shadow">SAVE NEW</button>
                            
                            <!-- NEW: Update Record Button (Hidden initially) -->
                            <button id="updateBtn" onclick="saveDataToSheet('update')" class="admin-only hidden bg-purple-600 text-white px-4 py-1 rounded font-bold text-xs hover:bg-purple-700 shadow">UPDATE RECORD</button>
                            
                            <!-- UNLOCK BUTTON FOR MAIN FORM -->
                            <button id="unlockBtn" onclick="unlockForm(false)" class="admin-only hidden bg-gray-600 text-white px-4 py-1 rounded font-bold text-xs hover:bg-gray-700 shadow">UNLOCK</button>
                            
                            <button id="addTableBtn" onclick="addNewTableBlock()" class="admin-only bg-orange-600 text-white px-3 py-1 rounded font-bold text-xs hover:bg-orange-700 shadow">Add Tariff</button>
                            
                            <button onclick="resetForm()" class="admin-only bg-red-500 text-white px-3 py-1 rounded font-bold text-xs hover:bg-red-600 shadow">New Sheet</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="printArea" class="page-container max-w-[1600px] mx-auto bg-form-base shadow-2xl p-6 rounded-lg border border-gray-400 text-black min-h-[800px]">
                <!-- Header -->
                <div class="border-b-4 border-blue-900 pb-2 mb-4 flex justify-between items-start">
                    <div><h2 class="text-xl font-extrabold text-blue-900 uppercase">Export Rail Tariff Sheet</h2><p class="text-gray-700 text-xs font-bold uppercase">(Export Rail Margins & Billing)</p></div>
                    <div class="text-right">
                        <div class="flex items-center justify-end mb-1"><span class="text-xs font-bold text-gray-800 mr-2 uppercase">Ref No:</span><input type="text" id="tariffNo" readonly class="text-right font-mono font-bold text-blue-900 border-none w-32 bg-transparent"></div>
                        <div class="flex items-center justify-end"><span class="text-xs font-bold text-gray-800 mr-2 uppercase">Date:</span><input type="date" id="dateToday" readonly class="text-right text-xs bg-transparent border-none w-32 font-bold"></div>
                    </div>
                </div>

                <!-- Basic Info -->
                <div class="grid grid-cols-5 gap-3 mb-4 bg-white p-4 rounded border border-gray-600 shadow-sm">
                    <div class="col-span-1"><label class="block text-[10px] font-bold text-blue-700 uppercase">Commodity *</label><select id="commodity" onchange="checkCommodityColor()" class="input-field h-8 bg-blue-50 text-blue-900"><option value="">-- Select --</option><option>AGRI COMMODITY</option><option>NON-AGRI COMMODITY</option></select></div>
                    <div class="col-span-2"><label class="block text-[10px] font-bold text-gray-600 uppercase">Customer Name *</label><input type="text" id="customerName" oninput="this.value=this.value.toUpperCase();" class="input-field font-bold text-blue-900 h-8 bg-white uppercase border-l-4 border-blue-600"></div>
                    <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Customer Type *</label><select id="customerType" class="input-field h-8 bg-white uppercase"><option value="">-- Select --</option><option>Shipper</option><option>CHA</option><option>Forwarder</option><option>Shipping Line</option><option>Transporter</option></select></div>
                    <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Vol / Month *</label><input type="text" id="volMonth" class="input-field h-8 bg-white uppercase" placeholder="TEUs"></div>
                    <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Credit Days *</label><input type="text" id="creditDays" class="input-field h-8 bg-white" list="creditOpts"><datalist id="creditOpts"><option value="- Days"><option value="15 Days"><option value="30 Days"></datalist></div>
                    <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Sales Person</label><select id="salesPerson" class="input-field h-8 bg-white font-bold text-blue-800"><option value="">-- Select --</option><option>ANURAG PANDEY</option><option>CHIRAG RANA</option><option>MOHIK SHARMA</option><option>DAMANJIT SINGH</option><option>HARSIMRANJEET SINGH</option><option>KUNAL SAHI</option><option>RAJESH KUMAR</option><option>SUMAN KUMARI</option><option>VIKRAM SINGH</option><option>ROHIN KALRA</option></select></div>
                    <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Billing Terms *</label><select id="billingTerms" class="input-field h-8 bg-white uppercase"><option value="">-- Select --</option><option>Net Billing</option><option>Net billing + CHA Commission</option><option>Commission Claimed</option></select></div>
                    <div class="col-span-1"><label class="block text-[10px] font-bold text-green-700 uppercase">Stream</label><input type="text" id="stream" value="Mundra - Kilaraipur" class="input-field h-8 bg-yellow-300 text-black border-yellow-500 font-extrabold"></div>
                    <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-600 uppercase">Status</label><div id="mainStatus" class="input-field h-8 flex items-center justify-center font-bold text-[10px] uppercase rounded border text-center status-pending">-</div></div>
                </div>

                <!-- Transport Table -->
                <div class="mb-1 pt-4 border border-gray-600 bg-white p-2 rounded">
                    <div class="flex justify-between items-end mb-1">
                        <div class="bg-gray-700 text-white px-3 py-1.5 rounded-t font-bold text-xs uppercase w-48"><i class="fas fa-truck mr-2"></i> Transport Tariff</div>
                        <div class="mb-1 flex items-center gap-2">
                            <label class="text-[10px] font-bold text-gray-700 uppercase">Claimed By:</label><input type="text" class="border border-gray-600 rounded px-2 py-0.5 text-xs font-bold w-80 bg-white uppercase" value="TRANSPORTER">
                            <button onclick="addTransportRow({}, 'tbodyTransport')" class="bg-white text-gray-800 hover:bg-gray-100 text-[10px] font-bold px-2 py-0.5 rounded no-print shadow uppercase border border-gray-600">Add Location</button>
                        </div>
                    </div>
                    <table class="tariff-table border border-gray-600">
                        <thead><tr class="text-white" style="background-color: #4b5563;"><th class="w-32">Transporter</th><th class="w-32">Origin</th><th class="w-32">Destination</th><th class="w-24">Discount (₹) 20"</th><th class="w-24">Discount (₹) 40"</th><th class="w-64">Remarks</th><th class="bg-white border-none w-6 no-print"></th></tr></thead>
                        <tbody id="tbodyTransport"></tbody>
                    </table>
                </div>

                <!-- Incentive Table -->
                <div class="mb-12 pt-2 bg-white p-2 rounded border border-gray-600">
                    <div class="flex justify-between items-end mb-1">
                        <div class="bg-gray-700 text-white px-3 py-1.5 rounded-t font-bold text-xs uppercase"><i class="fas fa-coins mr-2"></i> Incentive Details</div>
                        <div class="mb-1 flex items-center gap-2">
                            <label class="text-[10px] font-bold text-gray-700 uppercase">Claimed By:</label><input type="text" class="border border-gray-600 rounded px-2 py-0.5 text-xs font-bold w-80 bg-white uppercase" value="CHA">
                            <button onclick="addIncentiveRow({}, 'tbodyIncentive')" class="bg-white text-gray-800 hover:bg-gray-100 text-[10px] font-bold px-2 py-0.5 rounded no-print shadow uppercase border border-gray-700">Add Row</button>
                        </div>
                    </div>
                    <table class="tariff-table border border-gray-600">
                        <thead><tr class="text-white" style="background-color: #4b5563;"><th class="w-48">Line</th><th class="w-24">Discount 20"</th><th class="w-24">Discount 40"</th><th class="w-96">Remarks</th><th class="bg-white border-none w-6 no-print"></th></tr></thead>
                        <tbody id="tbodyIncentive"></tbody>
                    </table>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div class="bg-yellow-50 p-2 rounded border border-gray-600"><label class="block text-[10px] font-bold text-yellow-900 mb-1 uppercase">1. THC Subsidy Remarks</label><textarea id="remTHC" class="w-full border border-gray-500 rounded p-1 text-xs bg-white resize-none" rows="4"></textarea></div>
                    <div class="bg-blue-50 p-2 rounded border border-gray-600"><label class="block text-[10px] font-bold text-blue-900 mb-1 uppercase">2. Special Arrangements</label><textarea id="remSpecial" class="w-full border border-gray-500 rounded p-1 text-xs bg-white resize-none" rows="4"></textarea></div>
                    <div class="bg-gray-50 p-2 rounded border border-gray-600"><label class="block text-[10px] font-bold text-gray-900 mb-1 uppercase">3. ADDITIONAL REMARKS</label><textarea id="remAdd" class="w-full border border-gray-500 rounded p-1 text-xs bg-white resize-none" rows="4"></textarea></div>
                </div>

                <div id="tablesContainer"></div>

                <div class="mt-6 pt-4 border-t border-gray-600 flex justify-between print-only">
                    <div class="text-center"><p class="font-bold text-[10px] border-t border-black px-8 pt-1 inline-block text-black uppercase">Prepared By</p><div id="preparedByName" class="text-[10px] font-bold text-black uppercase mt-1"></div></div>
                    <div class="text-center"><p class="font-bold text-[10px] border-t border-black px-8 pt-1 inline-block text-black uppercase">Approved By</p></div>
                </div>
            </div>
        </div>
        <!-- END MAIN FORM CONTAINER -->

        <!-- APPROVAL FORM CONTAINER (Initially Hidden) -->
        <div id="approvalContainer">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-blue-900 uppercase">New Approval Request</h2>
                <div class="flex gap-2 flex-wrap justify-end">
                    <button onclick="toggleApprovalMode(false)" class="bg-gray-500 text-white px-3 py-1.5 rounded text-xs font-bold">Back</button>
                    <button onclick="refreshApproval()" class="bg-purple-600 text-white px-3 py-1.5 rounded text-xs font-bold"><i class="fas fa-sync mr-1"></i> New</button>
                    
                    <!-- NEW: All Tariffs Dropdown -->
                    <select id="allTariffHistory" class="border border-gray-400 rounded px-2 py-1 text-xs w-48 text-blue-900 font-bold bg-white" onchange="loadTariffRecord()">
                        <option>-- Tariffs --</option>
                    </select>

                    <!-- EXISTING: Approval History (Now Filtered) -->
                    <select id="approvalHistory" class="border border-gray-400 rounded px-2 py-1 text-xs w-48 text-blue-900 font-bold bg-blue-50" onchange="loadApprovalRecord()">
                        <option>-- Pending Approvals --</option>
                    </select>
                    
                    <button id="saveAppBtn" onclick="saveDataToSheet()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded shadow text-xs font-bold animate-pulse">SAVE APPROVAL</button>
                    
                    <!-- EXISTING BUTTON -->
                    <button onclick="downloadApprovalAsImage()" class="bg-teal-600 text-white px-4 py-1.5 rounded text-xs font-bold shadow hover:bg-teal-700" title="Download as Image"><i class="fas fa-image mr-1"></i> Img</button>
                    
                    <!-- NEW BUTTONS REQUESTED -->
                    <button onclick="downloadApprovalAsExcel()" class="bg-emerald-700 text-white px-4 py-1.5 rounded text-xs font-bold shadow hover:bg-emerald-800" title="Download Excel with Formatting"><i class="fas fa-file-excel mr-1"></i> Excel</button>
                    <button onclick="downloadApprovalAsHTML()" class="bg-orange-500 text-white px-4 py-1.5 rounded text-xs font-bold shadow hover:bg-orange-600" title="Download HTML with Box Formatting"><i class="fas fa-file-code mr-1"></i> HTML</button>

                    <!-- UNLOCK BUTTON FOR EVERYONE IN APPROVAL MODE (No admin-only class) -->
                    <button id="unlockAppBtn" onclick="unlockForm(true)" class="bg-purple-600 text-white px-4 py-1.5 rounded text-xs font-bold hover:bg-purple-700 shadow hidden">UNLOCK</button>
                </div>
            </div>
            
            <!-- NEW: Email Template Box at Top (Fixed Style) -->
            <div class="mb-4 border border-blue-200 bg-blue-50 p-2 rounded shadow-sm">
                <div class="flex gap-2 mb-2 flex-wrap">
                    <button onclick="setTemplateNewApproval()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-blue-700">New Approval</button>
                    <button onclick="setTemplateCustomerAdd()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-green-700">Customer Addition</button>
                    <button onclick="setTemplateAddLine()" class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-purple-700">Add Shipping Line</button>
                </div>
                <textarea id="approvalEmailBody" class="w-full bg-transparent text-black text-xs font-mono font-medium min-h-[128px] resize-none focus:outline-none overflow-hidden" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'" placeholder="Select a template button above..."></textarea>
            </div>

            <table class="app-table">
                <tr>
                    <td class="app-label">Commodity *</td><td><select id="ap_commodity" class="app-input"><option value="">-- Select --</option><option>AGRI COMMODITY</option><option>NON-AGRI COMMODITY</option></select></td>
                    <td class="app-label">Customer Name *</td><td><input type="text" id="ap_customerName" class="app-input uppercase" placeholder="ENTER NAME"></td>
                </tr>
                <tr>
                    <td class="app-label">Customer Type *</td><td><select id="ap_customerType" class="app-input uppercase"><option value="">-- Select --</option><option>Shipper</option><option>CHA</option><option>Forwarder</option><option>Shipping Line</option><option>Transporter</option></select></td>
                    <td class="app-label">Vol / Month *</td><td><input type="text" id="ap_volMonth" class="app-input uppercase"></td>
                </tr>
                <tr>
                    <td class="app-label">Credit Days *</td><td><input type="text" id="ap_creditDays" class="app-input" list="creditOpts"></td>
                    <td class="app-label">Sales Person</td><td><select id="ap_salesPerson" class="app-input"><option value="">-- Select --</option><option>ANURAG PANDEY</option><option>CHIRAG RANA</option><option>MOHIK SHARMA</option><option>DAMANJIT SINGH</option><option>HARSIMRANJEET SINGH</option><option>KUNAL SAHI</option><option>RAJESH KUMAR</option><option>SUMAN KUMARI</option><option>VIKRAM SINGH</option><option>ROHIN KALRA</option></select></td>
                </tr>
                <tr>
                    <td class="app-label">Billing Terms *</td><td><select id="ap_billingTerms" class="app-input uppercase"><option value="">-- Select --</option><option>Net Billing</option><option>Net billing + CHA Commission</option><option>Commission Claimed</option></select></td>
                    <td class="app-label">Stream</td><td><input type="text" id="ap_stream" value="Mundra - Kilaraipur" class="app-input bg-yellow-200"></td>
                </tr>
            </table>

            <!-- NEW: MOVED Customer List (Select to Load) Above Transport -->
            <div id="approvalCustomerListContainer" class="hidden mb-4">
                <h3 class="text-xs font-bold text-blue-900 mb-1">Customer List</h3>
                <ul id="approvalCustomerList" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto"></ul>
            </div>

            <!-- COMPLETE TRANSPORT TABLE FOR APPROVAL -->
            <div class="mb-4">
                <div class="flex justify-between items-end mb-1 border-b border-amber-800 pb-1">
                    <h4 class="font-bold text-xs text-amber-800">Transport Tariff Details</h4>
                    <button onclick="addTransportRow({}, 'tbodyTransport_ap')" class="bg-amber-700 text-white hover:bg-amber-800 text-[10px] font-bold px-2 py-0.5 rounded shadow">Add Location</button>
                </div>
                <table class="tariff-table border border-gray-600">
                    <thead><tr class="text-white bg-gray-300"><th class="w-32">Transporter</th><th class="w-32">Origin</th><th class="w-32">Destination</th><th class="w-24">Discount 20"</th><th class="w-24">Discount 40"</th><th class="w-64">Remarks</th><th class="w-6"></th></tr></thead>
                    <tbody id="tbodyTransport_ap"></tbody>
                </table>
            </div>

            <!-- COMPLETE INCENTIVE TABLE FOR APPROVAL -->
            <div class="mb-4">
                <div class="flex justify-between items-end mb-1 border-b border-teal-800 pb-1">
                    <h4 class="font-bold text-xs text-teal-800">Incentive Details</h4>
                    <button onclick="addIncentiveRow({}, 'tbodyIncentive_ap')" class="bg-teal-700 text-white hover:bg-teal-800 text-[10px] font-bold px-2 py-0.5 rounded shadow">Add Row</button>
                </div>
                <table class="tariff-table border border-gray-600">
                    <thead><tr class="text-white bg-gray-300"><th class="w-48">Line</th><th class="w-24">Discount 20"</th><th class="w-24">Discount 40"</th><th class="w-96">Remarks</th><th class="w-6"></th></tr></thead>
                    <tbody id="tbodyIncentive_ap"></tbody>
                </table>
            </div>

            <div class="mb-4">
                <label class="block text-xs font-bold app-label">1. THC Subsidy Remarks</label><textarea id="ap_remTHC" class="app-input h-10 resize-none"></textarea>
                <label class="block text-xs font-bold mt-1 app-label">2. Special Arrangements</label><textarea id="ap_remSpecial" class="app-input h-10 resize-none"></textarea>
                <label class="block text-xs font-bold mt-1 app-label">3. ADDITIONAL REMARKS</label><textarea id="ap_remAdd" class="app-input h-10 resize-none"></textarea>
            </div>
            
            <div class="h-4 bg-gray-100 mb-4 border-t border-b border-gray-300"></div>
            <div id="ap_tablesContainer"></div>
        </div>
        <!-- END APPROVAL FORM CONTAINER -->

    </div> 
    <!-- END LEFT CONTENT AREA -->

    <!-- SIDEBAR (Always Visible now) -->
    <div class="sidebar no-print p-2">
        <!-- ... existing sidebar code ... -->
        <div class="sticky top-0 bg-white z-10 pb-2 border-b border-gray-300"> 
            <h2 class="text-sm font-bold text-gray-800 mb-2 text-center uppercase tracking-widest">Customer List</h2>
            <input type="text" id="sidebarSearch" placeholder="Search..." onkeyup="filterSidebarList()" class="w-full border border-blue-300 rounded px-2 py-1 text-xs mb-2 mt-1 focus:outline-none focus:border-blue-600 text-black font-bold">
            <button onclick="openCustomerModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-1.5 px-3 rounded font-bold text-xs flex items-center justify-center shadow"><i class="fas fa-plus mr-2"></i> Add Customer</button>
        </div>
        <div class="flex justify-between text-[10px] font-bold text-gray-500 border-b border-gray-200 py-1 px-2 bg-gray-50"><span>Name</span><span>Date</span></div>
        <div class="overflow-y-auto h-[calc(100vh-160px)]"><ul id="customerList" class="space-y-0.5"></ul></div>
    </div>
</div>

<!-- MODALS & LOADING -->
<!-- ... existing modals ... -->
<div id="loadingOverlay" class="overlay hidden" style="background: rgba(0,0,0,0.8);">
    <div class="bg-white p-6 rounded shadow-xl w-96 border border-gray-300 text-center">
        <div id="progressSection"><div class="mb-4"><div class="animate-spin rounded-full h-10 w-10 border-b-4 border-blue-600 mx-auto"></div></div><h2 class="text-lg font-bold text-blue-900 mb-2">Processing...</h2><div class="w-full bg-gray-200 rounded-full h-3 mb-1 overflow-hidden"><div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div></div><p class="text-xs text-gray-500 font-mono" id="progressText">0%</p></div>
        <div id="successSection" class="hidden"><div class="mb-3 text-green-500 text-6xl animate-bounce"><i class="fas fa-check-circle"></i></div><h2 class="text-xl font-extrabold text-gray-800 mb-4">Success!</h2><button onclick="closeLoading()" class="bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow">OK</button></div>
    </div>
</div>
<div id="docPreviewModal" class="hidden fixed z-50 left-0 top-0 w-full h-full bg-black bg-opacity-80 flex items-center justify-center">
    <div class="bg-white p-5 w-11/12 max-w-2xl rounded text-center relative max-h-[90vh] overflow-y-auto"><span class="absolute top-2 right-4 text-2xl font-bold cursor-pointer" onclick="closeDocModal()">&times;</span><h3 class="text-lg font-bold text-blue-900 mb-2">Preview</h3><div id="docModalBody"></div><div class="mt-4"><a id="fullDocLink" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold mr-2">Open</a><a id="downloadDocLink" class="bg-orange-600 text-white px-4 py-2 rounded text-xs font-bold">Download</a></div></div>
</div>
<div id="customerModal" class="overlay hidden" style="background: rgba(0,0,0,0.6);">
    <div class="bg-white p-6 rounded shadow-xl w-96 border border-gray-300">
        <h3 class="font-bold text-lg mb-2 text-blue-900">Add Customers</h3><textarea id="bulkCustomerInput" class="w-full border border-gray-400 rounded p-2 text-sm h-32 text-black" placeholder="Name A, Name B..."></textarea>
        <div class="flex justify-end gap-2 mt-4"><button onclick="closeCustomerModal()" class="px-4 py-1 bg-gray-400 text-white rounded text-xs font-bold">Cancel</button><button onclick="saveBulkCustomers()" class="px-4 py-1 bg-green-600 text-white rounded text-xs font-bold">Add</button></div>
    </div>
</div>
<div id="reportModal" class="overlay hidden" style="background: rgba(0,0,0,0.9);">
    <div class="bg-white rounded-lg shadow-2xl w-[95%] h-[90%] flex flex-col border border-gray-600">
        <div class="bg-gray-800 p-4 border-b border-gray-600 flex justify-between items-center"><h2 class="text-xl font-bold text-white">Reports</h2><button onclick="closeReportModal()" class="text-white text-2xl">&times;</button></div>
        <div class="bg-gray-200 p-2 flex gap-2 items-center flex-wrap"><select id="reportFilterCustomerSelect" class="border border-black text-black rounded px-2 py-1 text-xs font-bold" onchange="generateMasterReport()"></select><input type="text" id="reportFilterCust" placeholder="Search..." class="border border-black text-black rounded px-2 py-1 text-xs w-40 font-bold" oninput="generateMasterReport()"><select id="reportFilterSales" class="border border-black text-black rounded px-2 py-1 text-xs font-bold" onchange="generateMasterReport()"></select><select id="reportFilterComm" class="border border-black text-black rounded px-2 py-1 text-xs font-bold" onchange="generateMasterReport()"></select><select id="reportFilterLine" class="border border-black text-black rounded px-2 py-1 text-xs font-bold" onchange="generateMasterReport()"></select><select id="reportFilterType" class="border border-black text-black rounded px-2 py-1 text-xs font-bold" onchange="generateMasterReport()"></select><button onclick="resetReportFilters()" class="text-xs text-blue-600 ml-2">Reset</button></div>
        <div class="bg-gray-100 p-2 flex gap-2"><button onclick="generateMasterReport()" class="px-3 py-2 bg-blue-600 text-white rounded font-bold text-xs">Master Report</button><button onclick="exportReportToExcel()" class="px-3 py-2 bg-emerald-700 text-white rounded font-bold text-xs">Excel</button></div>
        <div class="flex-1 overflow-auto p-4 bg-gray-50 text-black" id="reportContent"></div>
    </div>
</div>

<script>
    const PUBLIC_KEY="Hb0oU56d79ASV96Nh",SERVICE_ID="service_kqh6am4",TEMPLATE_ID="template_bwpw6sk";
    (function(){emailjs.init(PUBLIC_KEY)})();
    const USER_DATABASE={"ANURAG PANDEY":{pass:"ANURAGP@121",email:"Anurag.Pandey@hindterminals.com"},"CHIRAG RANA":{pass:"CRANA@122",email:"Chirag.Rana@hindterminals.com"},"MOHIK SHARMA":{pass:"HIKSHA@123",email:"Mohik.Sharma@hindterminals.com"},"DAMANJIT SINGH":{pass:"ANJITSIN@124",email:"Damanjit.Singh@hindterminals.com"},"HARSIMRANJEET SINGH":{pass:"JEETSINGH@125",email:"Harsimranjeet.Singh@hindterminals.com"},"KUNAL SAHI":{pass:"NALSAHI@126",email:"Kunal.sahi@hindterminals.com"},"RAJESH KUMAR":{pass:"JESHKU@127",email:"rajesh.kumar@hindterminals.com"},"ROHIN KALRA":{pass:"ROHINK@3339",email:"rohin.kalra@hindterminals.com"},"ACCOUNTS":{pass:"ACC@8989",email:"sumit.thakur@hindterminals.com"},"SUMAN KUMARI":{pass:"16111980",email:"Suman.kumari@hindterminals.com"},"VIKRAM SINGH":{pass:"16111980",email:"Vikram.singh@hindterminals.com"}};
    const ADMIN_USERS=['SUMAN KUMARI','VIKRAM SINGH','ROHIN KALRA'];
    const CONFIG={SCRIPT_URL:'https://script.google.com/macros/s/AKfycbzbG1Lg0-gYLmnuXgkgC3f2_L_s1oDJ0tP8J5ryGYWM2o-WfqANSsH_hd2707NHrboD/exec',SHEET_ID:'1iWYD0BShhoVYOx0HLkvs8-fz53JQisjuvARFGpt9hzg'};
    const cloudName="drbrz3rqv",uploadPreset="ml_default";
    let tableCounter=0,customerList=[],sheetRecords=[],editingRecordRef=null,isApprovalMode=false;
    const slabs=[{label:'20" 00 MT - 10 MT',p:30690,m:10092},{label:'20" 10 MT - 20 MT',p:38720,m:12595},{label:'20" 20 MT - 26 MT',p:46200,m:14512},{label:'20" 26 MT - 30 MT',p:50820,m:15378},{label:'20" Above 30.1 MT',p:50820,m:15378},{label:'40" Upto - 20 MT',p:53790,m:17275},{label:'40" Over - 20 MT',p:65890,m:19425}];
    const subsidyData={'FACTORY':[0,0,0,0,0,0,0],'OWPL':[3200,3200,3200,3200,3200,5600,5600],'PSWC':[2500,2500,2500,2500,2500,4500,4500],'Double -2x20"':[0,0,0,0,0,0,0]};
    const lineData={'CUSTOMER':{bss:[0,0,0,0,0,0,0],rail:[0,0,0,0,0,0,0],wh:[0,0,0,0,0,0,0],fs:[0,0,0,0,0,0,0],self:[0,0,0,0,0,0,0]},'MSC':{bss:[933,1161,1335,1414,1414,1548,1744],rail:[500,500,500,500,500,500,500],wh:[0,0,0,0,0,0,0],fs:[0,0,0,0,0,0,0],self:[0,0,0,0,0,0,0]},'COSCO':{bss:[0,0,0,0,0,0,0],rail:[1490,2120,1900,2320,-2980,2790,2790],wh:[0,0,0,0,0,0,0],fs:[0,0,0,0,0,0,0],self:[0,0,0,0,0,0,0]},'HAPAG':{bss:[933,1161,1335,1414,1414,1548,1744],rail:[600,600,600,600,600,1200,1200],wh:[2095,2095,2095,2162,4187,2550,2550],fs:[2570,2570,2570,2612,4562,3650,3650],self:[910,910,910,800,2225,700,700]},'CMA CGM':{bss:[933,910,1050,1120,1120,1290,1190],rail:[500,500,500,500,500,1000,1000],wh:[0,0,0,0,0,0,0],fs:[0,0,0,0,0,0,0],self:[0,0,0,0,0,0,0]},'HMM LINE':{bss:[933,1161,1335,1414,1414,1548,1744],rail:[750,750,750,750,750,1250,1250],wh:[0,0,0,0,0,0,0],fs:[0,0,0,0,0,0,0],self:[0,0,0,0,0,0,0]},'MAERSK':{bss:[5964,6632,9000,9630,9630,8552,10047],rail:[933,1161,1335,1414,1414,1548,1744],wh:[-1598,-1598,-1598,-923,1102,-1576,-1576],fs:[-1123,-1123,-1123,-473,1477,-476,-476],self:[-2243,-2243,-2243,-1768,-343,-2696,-2696]},'OTHER':{bss:[0,0,0,0,0,0,0],rail:[0,0,0,0,0,0,0],wh:[0,0,0,0,0,0,0],fs:[0,0,0,0,0,0,0],self:[0,0,0,0,0,0,0]}};
    ['OOCL','SEABRIDGE','ONE LINE'].forEach(k=>lineData[k]=lineData['OTHER']);
// --- DELETE CUSTOMER FUNCTION ---
    function deleteCustomer(index, event) {
        // Ye line zaroori hai taaki delete dabane par customer load na ho jaye
        if(event) event.stopPropagation(); 
        
        if(confirm("Are you sure you want to delete this customer?")) {
            // List se uss index waale customer ko hatao
            customerList.splice(index, 1);
            // List ko wapas refresh karo
            renderCustomerList();
        }
    }
    
// --- CUSTOMER MODAL & ADD FUNCTION START ---
    
    function openCustomerModal() {
        const modal = document.getElementById('customerModal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex'; // Ensure flex is set for centering
    }

    function closeCustomerModal() {
        const modal = document.getElementById('customerModal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }

    function saveBulkCustomers() {
        const input = document.getElementById('bulkCustomerInput');
        const rawText = input.value;
        
        if (!rawText.trim()) {
            alert("Please enter customer names.");
            return;
        }

        // Names ko Comma (,) ya New Line (Enter) se split karein
        const newNames = rawText.split(/[\n,]+/).map(n => n.trim()).filter(n => n.length > 0);

        newNames.forEach(name => {
            // Duplicate check: Agar list me pehle se nahi hai tabhi add karein
            const exists = customerList.some(c => c.name.toUpperCase() === name.toUpperCase());
            if (!exists) {
                customerList.push({
                    name: name.toUpperCase(),
                    date: new Date().toISOString().split('T')[0] // Aaj ki date
                });
            }
        });

        // List ko wapas draw karein
        renderCustomerList();
        
        // Input clear karein aur modal band karein
        input.value = '';
        closeCustomerModal();
    }
    
    // Search Filter for Sidebar (Ye bhi missing tha)
    function filterSidebarList() {
        const term = document.getElementById('sidebarSearch').value.toLowerCase();
        const items = document.querySelectorAll('#customerList li');
        items.forEach(item => {
            const name = item.querySelector('span').innerText.toLowerCase();
            if (name.includes(term)) {
                item.style.display = "flex";
            } else {
                item.style.display = "none";
            }
        });
    }

    // --- CUSTOMER MODAL & ADD FUNCTION END ---

    // --- HELPER FUNCTIONS MOVED TO TOP ---
    function getVal(id){return document.getElementById(id)?document.getElementById(id).value:''}
    function disableAllInputs(d){document.querySelectorAll('input,select,textarea').forEach(e=>{if(!['searchBox','cloudHistory','approvalHistory','allTariffHistory','mainApprovalHistory','approvalEmailBody'].includes(e.id)&&!e.id.startsWith('reportFilter')&&!e.id.startsWith('docLink_'))e.disabled=d})}
    function checkCommodityColor(){const c=document.getElementById('commodity');c.classList.remove('bg-yellow-300','bg-green-300','bg-blue-50');if(c.value==='NON-AGRI COMMODITY')c.classList.add('bg-yellow-300');else if(c.value==='AGRI COMMODITY')c.classList.add('bg-green-300');else c.classList.add('bg-blue-50');}
    
// UPDATED: Render Customer List with Delete Button
    function renderCustomerList(){
        // Sidebar List (Ab isme Delete Button bhi hai)
        const listHtml = customerList.map((c,i)=>`
            <li class="py-1 px-2 border-b text-[10px] flex justify-between items-center customer-item rounded ${i%2===0?'bg-blue-200':'bg-blue-50'}" onclick="findAndLoadCustomer('${c.name}')">
                <div class="flex flex-col overflow-hidden">
                    <span class="font-bold text-gray-700 truncate">${c.name}</span>
                    <span class="text-[9px] text-gray-400">${c.date||''}</span>
                </div>
                <button onclick="deleteCustomer(${i}, event)" class="text-red-500 hover:text-red-700 font-bold text-xs p-1 ml-2 z-10" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </li>`).join('');
        document.getElementById('customerList').innerHTML = listHtml;

        // Horizontal List for Approval View
        const approvalListHtml = customerList.map(c => `<li class="py-1 px-2 border text-[10px] flex items-center gap-2 customer-item rounded bg-white hover:bg-blue-50 cursor-pointer shadow-sm" onclick="findAndLoadCustomer('${c.name}')"><span class="font-bold text-sky-500">${c.name}</span><span class="text-[9px] text-gray-500">(${c.date||''})</span></li>`).join('');
        document.getElementById('approvalCustomerList').innerHTML = approvalListHtml;
    }

    // --- TEMPLATE FUNCTIONS ---
    function setTemplateNewApproval() {
        document.getElementById('approvalEmailBody').value = "Dear Sir,\n\n\n\n \nThanks & Regards";
        document.getElementById('approvalEmailBody').style.height = 'auto'; 
        document.getElementById('approvalEmailBody').style.height = document.getElementById('approvalEmailBody').scrollHeight + 'px';
    }
    function setTemplateCustomerAdd() {
        const c = document.getElementById('ap_customerName').value || "Customer Name";
        document.getElementById('approvalEmailBody').value = `Dear Sir, \n \nPlease Approve Below Addition of Shipper in A/c of "${c}" (Non-Agri in all cost sheets) \n \nNew Shipper\nName:- ............................................\nWEF:-...................\nClearance Location :- ......................   \n\nThanks & Regards\nHTPL Customer Service`;
        document.getElementById('approvalEmailBody').style.height = 'auto'; 
        document.getElementById('approvalEmailBody').style.height = document.getElementById('approvalEmailBody').scrollHeight + 'px';
    }
    function setTemplateAddLine() {
        const c = document.getElementById('ap_customerName').value || "Customer Name";
        document.getElementById('approvalEmailBody').value = `Dear Sir,\n \nCustomer has started some bookings on .............. Line.\n \nPlease approve below cost sheet of "${c}" to gain this additional business from this customer.\n \nThanks & Regards\nHTPL Customer Service`;
        document.getElementById('approvalEmailBody').style.height = 'auto'; 
        document.getElementById('approvalEmailBody').style.height = document.getElementById('approvalEmailBody').scrollHeight + 'px';
    }

    function addTransportRow(d={}, targetId='tbodyTransport'){const tr=document.createElement('tr');const s=(v,o)=>v===o?'selected':'';tr.innerHTML=`<td><input type="text" class="font-bold w-full uppercase" value="${d.t||'TRANSPORTER'}"></td><td>Kilaraipur</td><td><select class="font-bold w-full"><option ${s(d.d,'Ludhiana')}>Ludhiana</option><option ${s(d.d,'Mandi')}>Mandi</option></select></td><td><input type="number" class="font-bold w-full" value="${d.d20||''}"></td><td><input type="number" class="font-bold w-full" value="${d.d40||''}"></td><td><textarea class="w-full font-bold resize-none" rows="2">${d.rem||''}</textarea></td><td class="no-print"><button onclick="this.closest('tr').remove()" class="text-red-500 no-pdf">X</button></td>`;document.getElementById(targetId).appendChild(tr)}
    function addIncentiveRow(d={}, targetId='tbodyIncentive'){const tr=document.createElement('tr');tr.innerHTML=`<td><input type="text" class="font-bold w-full uppercase" value="${d.l||'MSC'}"></td><td><input type="number" class="font-bold w-full" value="${d.d20||''}"></td><td><input type="number" class="font-bold w-full" value="${d.d40||''}"></td><td><textarea class="font-bold w-full resize-none" rows="2">${d.rem||''}</textarea></td><td class="no-print"><button onclick="this.closest('tr').remove()" class="text-red-500 no-pdf">X</button></td>`;document.getElementById(targetId).appendChild(tr)}
    
    function calcTableRow(id,i){
        const g=(k)=>parseFloat(document.getElementById(`t_${id}_${k}_${i}`).value)||0;
        const b=g('disc')+g('slr')+g('slb')+g('cha')+g('fwd')+g('sub'),rm=g('railm');
        document.getElementById(`t_${id}_res_w_${i}`).innerText=(rm-b-g('slw')).toFixed(0);
        document.getElementById(`t_${id}_res_f_${i}`).innerText=(rm-b-g('slf')).toFixed(0);
        document.getElementById(`t_${id}_res_s_${i}`).innerText=(rm-b-g('sls')).toFixed(0);
        document.getElementById(`t_${id}_res_t_${i}`).innerText=(g('pub')-g('disc')-g('slr')).toLocaleString();
    }

    function checkExpiryLogic(){
        const b=Array.from(document.querySelectorAll('.table-block')),g={};
        b.forEach(x=>{const i=x.id.split('_')[1],k=`${document.getElementById(`sl_${i}`).value}|${document.getElementById(`tt_${i}`).value}`;if(!g[k])g[k]=[];g[k].push({id:i})});
        const td=new Date().toISOString().split('T')[0];
        for(let k in g){g[k].forEach((x,i)=>{const last=i===g[k].length-1,dt=document.getElementById(`dt_${x.id}`).value,st=document.getElementById(`status_${x.id}`),hd=document.getElementById(`headerBox_${x.id}`),tb=document.getElementById(`tableBlock_${x.id}`),content=document.getElementById(`tableContent_${x.id}`),tglBtn=document.getElementById(`toggleBtn_${x.id}`);
        const isExp = (!last||(dt&&dt<td));
        if(isExp){
            st.innerText="EXPIRED";st.className="px-2 py-1.5 rounded text-[10px] font-bold text-center uppercase w-full status-expired";
            hd.classList.replace('bg-[#1e293b]','bg-red-800');
            tb.classList.remove('bg-white','border-gray-600');
            tb.classList.add('bg-red-50','border-red-800','border-4','expired-block');
            
            // Auto hide content if expired
            content.classList.add('hidden');
            if(tglBtn) tglBtn.innerHTML = '<i class="fas fa-eye"></i> Show';
        }else{
            st.innerText="Approved & Valid";st.className="px-2 py-1.5 rounded text-[10px] font-bold text-center uppercase w-full status-valid";
            hd.classList.replace('bg-red-800','bg-[#1e293b]');
            tb.classList.add('bg-white','border-gray-600');
            tb.classList.remove('bg-red-50','border-red-800','border-4','expired-block');
            
            content.classList.remove('hidden');
            if(tglBtn) tglBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
        }})}
    }

    function toggleTableContent(id) {
        const content = document.getElementById(`tableContent_${id}`);
        const btn = document.getElementById(`toggleBtn_${id}`);
        if(content.classList.contains('hidden')){
            content.classList.remove('hidden');
            btn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
        } else {
            content.classList.add('hidden');
            btn.innerHTML = '<i class="fas fa-eye"></i> Show';
        }
    }

    function updateTableValues(id,pres=false){
        const t=document.getElementById(`tt_${id}`).value||'FACTORY',l=document.getElementById(`sl_${id}`).value||'OTHER',s=subsidyData[t]||subsidyData['FACTORY'],o=lineData[l]||lineData['OTHER'];
        if(!pres){slabs.forEach((_,i)=>{document.getElementById(`t_${id}_sub_${i}`).value=s[i]||"";document.getElementById(`t_${id}_slr_${i}`).value=o.rail[i]||"";document.getElementById(`t_${id}_slb_${i}`).value=o.bss[i]||"";document.getElementById(`t_${id}_slw_${i}`).value=o.wh[i]||"";document.getElementById(`t_${id}_slf_${i}`).value=o.fs[i]||"";document.getElementById(`t_${id}_sls_${i}`).value=o.self[i]||""})}
        slabs.forEach((_,i)=>{document.getElementById(`t_${id}_lbl_${i}`).value=`${l}/${t}`;calcTableRow(id,i)});checkExpiryLogic();
    }

    function addNewTableBlock(){
        tableCounter++;const id=tableCounter,div=document.createElement('div');div.className="table-block mb-16 border border-gray-600 bg-white pb-4 rounded p-2 shadow-sm";div.id=`tableBlock_${id}`;
        let rows='';slabs.forEach((s,i)=>{// Is puri line ko replace karein:
rows+=`<tr class="${s.label.includes('40" Upto')||s.label.includes('40" Over')?'highlight-row':''}"><td class="bg-yellow-100"><input type="text" id="t_${id}_lbl_${i}" class="font-bold text-blue-900 w-full" readonly></td><td class="font-bold bg-transparent whitespace-nowrap">${s.label}</td><td><input type="number" id="t_${id}_pub_${i}" value="${s.p}" readonly tabindex="-1"></td><td><input type="number" id="t_${id}_railm_${i}" value="${s.m}" readonly tabindex="-1"></td><td><input type="number" id="t_${id}_disc_${i}" oninput="calcTableRow(${id},${i})" class="bg-yellow-col"></td>
<td><input type="number" id="t_${id}_slr_${i}" oninput="calcTableRow(${id},${i})" class="bg-blue-50 font-bold text-blue-800"></td>
<td><input type="number" id="t_${id}_slb_${i}" readonly tabindex="-1"></td><td><input type="number" id="t_${id}_slw_${i}" oninput="calcTableRow(${id},${i})" class="bg-blue-50 font-bold text-blue-800"></td><td><input type="number" id="t_${id}_slf_${i}" oninput="calcTableRow(${id},${i})" class="bg-blue-50 font-bold text-blue-800"></td><td><input type="number" id="t_${id}_sls_${i}" oninput="calcTableRow(${id},${i})" class="bg-blue-50 font-bold text-blue-800"></td><td><input type="number" id="t_${id}_cha_${i}" oninput="calcTableRow(${id},${i})" class="bg-teal-col"></td><td><input type="number" id="t_${id}_fwd_${i}" oninput="calcTableRow(${id},${i})" class="bg-teal-col"></td><td><input type="number" id="t_${id}_sub_${i}" oninput="calcTableRow(${id},${i})" class="bg-yellow-col font-bold"></td><td class="bg-gray-col"><span id="t_${id}_res_w_${i}"></span></td><td class="bg-gray-col"><span id="t_${id}_res_f_${i}"></span></td><td class="bg-gray-col"><span id="t_${id}_res_s_${i}"></span></td><td class="bg-red-col"><span id="t_${id}_res_t_${i}"></span></td></tr>`});
        
        div.innerHTML=`
            <div id="headerBox_${id}" class="grid grid-cols-5 gap-4 mb-2 bg-[#1e293b] p-2 rounded border border-gray-800 items-end relative">
                <button id="toggleBtn_${id}" onclick="toggleTableContent(${id})" class="absolute top-0 right-0 m-1 text-white text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded shadow z-10"><i class="fas fa-eye-slash"></i> Hide</button>
                <div class="col-span-1 flex flex-col justify-end">
                    <button onclick="addNewTableBlock()" class="bg-orange-500 text-white text-[10px] font-bold py-1 px-2 rounded uppercase shadow mb-1 w-full">Add Tariff Table</button>
                    <div id="status_${id}" class="px-2 py-1.5 rounded text-[10px] font-bold text-center uppercase status-valid w-full">Approved & Valid</div>
                </div>
                <div class="col-span-1"><label class="block text-[10px] font-bold text-white uppercase">Type *</label><select id="tt_${id}" onchange="updateTableValues(${id})" class="input-field h-8 bg-purple-50 text-purple-900 border-purple-300"><option value="">-- Select --</option><option value="FACTORY">FACTORY</option><option value="OWPL">OWPL</option><option value="PSWC">PSWC</option><option value="Double -2x20"">Double -2x20"</option></select></div>
                <div class="col-span-1"><label class="block text-[10px] font-bold text-white uppercase">Line *</label><select id="sl_${id}" onchange="updateTableValues(${id})" class="input-field h-8 bg-white uppercase border-blue-500"><option value="">-- Select --</option>${Object.keys(lineData).map(k=>`<option value="${k}">${k}</option>`).join('')}</select></div>
                <div class="col-span-1"><label class="block text-[10px] font-bold text-white uppercase">From</label><input type="date" id="df_${id}" class="input-field h-8 bg-white"></div>
                <div class="col-span-1"><label class="block text-[10px] font-bold text-white uppercase">To</label><input type="date" id="dt_${id}" class="input-field h-8 bg-white" onchange="updateTableValues(${id},true)"></div>
            </div>
            
            <div id="tableContent_${id}" class="content-collapsible">
                <div class="upload-section-mini w-1/2 no-print mb-1"><div class="upload-box-mini inline-block mr-2" onclick="triggerUpload(${id})"><span style="font-size:18px;">📂</span> <span id="uploadStatus_${id}" class="text-xs font-bold text-gray-700">Upload Doc</span></div><input type="file" id="fileInput_${id}" style="display:none" onchange="uploadToCloudinary(this,${id})"><input type="hidden" id="docLink_${id}"><button type="button" id="previewBtn_${id}" class="bg-teal-600 text-white text-[10px] font-bold py-0.5 px-2 rounded hidden hover:bg-teal-700 shadow" onclick="openDocModal(${id})">View</button></div>
                <div class="mb-2"><textarea id="tbl_rem_${id}" class="w-full border border-black rounded p-1 text-xs bg-yellow-100 font-bold resize-none text-black" rows="2" placeholder="Table remarks..."></textarea></div>
                <div class="flex justify-end mb-1"><button onclick="if(confirm('Remove?')){this.closest('.table-block').remove();checkExpiryLogic();}" class="text-red-500 font-bold text-xs hover:underline no-pdf">Remove Table</button></div>
                <div class="overflow-x-auto"><table class="tariff-table border border-gray-600"><thead class="th-main text-white"><tr><th class="w-32">Line /Type</th><th class="w-40">Weight Slab</th><th>Public</th><th>Rail Margins</th><th class="bg-amber-600 border-amber-800">Discount Rail</th><th>Line Disc Rail</th><th>Line Disc BSS</th><th>Line Disc WH</th><th>Line Disc F/S</th><th>Line Disc Self</th><th class="bg-emerald-700 border-emerald-800">CHA Inc</th><th class="bg-emerald-700 border-emerald-800">Fwd Inc</th><th>Subsidy</th><th class="bg-slate-700 text-white border-slate-800">Margin WH</th><th class="bg-slate-700 text-white border-slate-800">Margin F/S</th><th class="bg-slate-700 text-white border-slate-800">Margin Self</th><th class="bg-red-700 text-white border-red-900">Billing</th></tr></thead><tbody>${rows}</tbody></table></div>
            </div>`;
        const container = isApprovalMode ? document.getElementById('ap_tablesContainer') : document.getElementById('tablesContainer');
        container.appendChild(div);
        updateTableValues(id);
    }

    function triggerUpload(id){document.getElementById(`fileInput_${id}`).click()}
    function uploadToCloudinary(inp,id){
        const f=inp.files[0];if(!f)return;
        document.getElementById(`uploadStatus_${id}`).innerText="Uploading...";
        const fd=new FormData();fd.append("file",f);fd.append("upload_preset",uploadPreset);
        fetch(`https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`,{method:"POST",body:fd}).then(r=>r.json()).then(d=>{if(d.secure_url){document.getElementById(`docLink_${id}`).value=d.secure_url;document.getElementById(`uploadStatus_${id}`).innerText="✅ Attached";document.getElementById(`previewBtn_${id}`).classList.remove('hidden');}}).catch(e=>{alert("Upload Failed");});
    }
    function openDocModal(id){const l=document.getElementById(`docLink_${id}`).value;if(!l)return;document.getElementById("fullDocLink").href=l;document.getElementById("downloadDocLink").href=l.replace('/upload/','/upload/fl_attachment/');document.getElementById("docModalBody").innerHTML=l.endsWith('.pdf')?`<iframe src="${l}" class="w-full h-[500px]"></iframe>`:`<img src="${l}" class="max-w-full max-h-[500px] mx-auto">`;document.getElementById("docPreviewModal").classList.remove('hidden');}
    function closeDocModal(){document.getElementById("docPreviewModal").classList.add('hidden')}

    // --- MAIN FUNCTIONS ---
    function attemptLogin(){
        const u=document.getElementById('loginUser').value,p=document.getElementById('loginPass').value;
        if(USER_DATABASE[u]&&USER_DATABASE[u].pass===p){
            document.getElementById('login-screen').style.display='none';document.getElementById('appContent').style.display='flex';
            const s=document.getElementById('salesPerson'),as=document.getElementById('ap_salesPerson');if(s)s.value=u;if(as)as.value=u;
            document.getElementById('currentUserDisplay').innerText=u;document.getElementById('preparedByName').innerText=u;
            const isAdmin=ADMIN_USERS.includes(u);
            document.querySelectorAll('.admin-only').forEach(b=>b.classList.toggle('hidden-by-role',!isAdmin));
            fetchSheetData();
        }else{alert("Invalid Credentials");}
    }
    
    function toggleApprovalMode(show, isFresh=false){
        isApprovalMode=show;
        const approvalListContainer = document.getElementById('approvalCustomerListContainer');
        if(show){
            document.getElementById('mainFormContainer').style.display='none';
            document.getElementById('approvalContainer').style.display='flex';
            // Show horizontal list in approval mode
            if(approvalListContainer) approvalListContainer.classList.remove('hidden');
            
            if(isFresh) {
                resetApprovalState();
                setTemplateNewApproval(); // Default text
            } else {
                syncMainToApproval();
            }
        }else{
            document.getElementById('mainFormContainer').style.display='block';
            document.getElementById('approvalContainer').style.display='none';
            // Hide horizontal list
            if(approvalListContainer) approvalListContainer.classList.add('hidden');
        }
    }
    
    // NEW: Copy Data to Approval Form Tables
    function syncMainToApproval(){
        const map={'commodity':'ap_commodity','customerName':'ap_customerName','customerType':'ap_customerType','volMonth':'ap_volMonth','creditDays':'ap_creditDays','salesPerson':'ap_salesPerson','billingTerms':'ap_billingTerms','stream':'ap_stream','remTHC':'ap_remTHC','remSpecial':'ap_remSpecial','remAdd':'ap_remAdd'};
        for(let k in map)document.getElementById(map[k]).value=document.getElementById(k).value;
        
        // Move Tables
        document.querySelectorAll('.table-block').forEach(t=>document.getElementById('ap_tablesContainer').appendChild(t));
        
        // SYNC Transport Table to Approval
        const tBodyMain = document.getElementById('tbodyTransport');
        document.getElementById('tbodyTransport_ap').innerHTML = "";
        tBodyMain.querySelectorAll('tr').forEach(tr => {
            const inputs = tr.querySelectorAll('input');
            const selects = tr.querySelectorAll('select');
            const txt = tr.querySelector('textarea');
            addTransportRow({
                t: inputs[0].value,
                d: selects[0].value,
                d20: inputs[1].value,
                d40: inputs[2].value,
                rem: txt.value
            }, 'tbodyTransport_ap');
        });

        // SYNC Incentive Table to Approval
        const iBodyMain = document.getElementById('tbodyIncentive');
        document.getElementById('tbodyIncentive_ap').innerHTML = "";
        iBodyMain.querySelectorAll('tr').forEach(tr => {
            const inputs = tr.querySelectorAll('input');
            const txt = tr.querySelector('textarea');
            addIncentiveRow({
                l: inputs[0].value,
                d20: inputs[1].value,
                d40: inputs[2].value,
                rem: txt.value
            }, 'tbodyIncentive_ap');
        });
    }

    // NEW: Refresh Button Logic
    function refreshApproval() {
        if(!confirm("Start Fresh Approval?")) return;
        resetApprovalState();
        setTemplateNewApproval();
    }

    // Shared Helper to Reset Approval View
    function resetApprovalState() {
        // 1. Clear Inputs
        document.querySelectorAll('#approvalContainer input, #approvalContainer textarea, #approvalContainer select').forEach(el => {
           if(el.id !== 'approvalHistory' && el.id !== 'allTariffHistory' && el.id !== 'approvalEmailBody') el.value = ""; 
        });
        // 2. Clear Static Tables
        document.getElementById('tbodyTransport_ap').innerHTML = "";
        document.getElementById('tbodyIncentive_ap').innerHTML = "";
        // Add one empty row for convenience in Fresh Mode
        addTransportRow({}, 'tbodyTransport_ap');
        addIncentiveRow({}, 'tbodyIncentive_ap');
        
        // 3. Clear Dynamic Tables
        document.getElementById('ap_tablesContainer').innerHTML = ""; 
        
        // 4. Add One Empty Tariff Table
        addNewTableBlock(); 

        // 5. Clear Customer List
        customerList = [];
        renderCustomerList();

        // 6. Make Editable
        disableAllInputs(false);
        // Reset ID for fresh creation
        editingRecordRef = null;
        document.getElementById('tariffNo').value = `AP-${new Date().getFullYear()}${Math.floor(1000+Math.random()*9000)}`;
	// --- NEW CODE: Re-enable Save Button ---
    	const appBtn = document.getElementById('saveAppBtn');
    	appBtn.disabled = false;
    	appBtn.innerText = "SAVE APPROVAL";
    	appBtn.classList.add('animate-pulse', 'hover:bg-green-700');
    	appBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-600');
    	// --- END ---
	}
    
    function captureFullData(){
        const p=isApprovalMode?'ap_':'';
        const basic={ref:document.getElementById('tariffNo').value,date:document.getElementById('dateToday').value,comm:getVal(p+'commodity'),cust:getVal(p+'customerName'),type:getVal(p+'customerType'),vol:getVal(p+'volMonth'),cred:getVal(p+'creditDays'),ver:getVal(p+'salesPerson'),bill:getVal(p+'billingTerms'),stream:getVal(p+'stream'),preparedBy:document.getElementById('preparedByName').innerText};
        const tables=[]; const docLinks=[];
        document.querySelectorAll('.table-block').forEach(b=>{
            const id=b.id.split('_')[1],rows=[];
            for(let i=0;i<7;i++)rows.push({pub:document.getElementById(`t_${id}_pub_${i}`).value,railm:document.getElementById(`t_${id}_railm_${i}`).value,disc:document.getElementById(`t_${id}_disc_${i}`).value,slr:document.getElementById(`t_${id}_slr_${i}`).value,slb:document.getElementById(`t_${id}_slb_${i}`).value,slw:document.getElementById(`t_${id}_slw_${i}`).value,slf:document.getElementById(`t_${id}_slf_${i}`).value,sls:document.getElementById(`t_${id}_sls_${i}`).value,cha:document.getElementById(`t_${id}_cha_${i}`).value,fwd:document.getElementById(`t_${id}_fwd_${i}`).value,sub:document.getElementById(`t_${id}_sub_${i}`).value});
            const dl=document.getElementById(`docLink_${id}`).value; if(dl)docLinks.push(dl);
            tables.push({tt:document.getElementById(`tt_${id}`).value,sl:document.getElementById(`sl_${id}`).value,df:document.getElementById(`df_${id}`).value,dt:document.getElementById(`dt_${id}`).value,rem:document.getElementById(`tbl_rem_${id}`).value,rows:rows,docLink:dl});
        });
        
        // Capture specific tables based on mode
        let transport=[], incentives=[];
        if(isApprovalMode) {
            document.querySelectorAll('#tbodyTransport_ap tr').forEach(tr=>{
                const inputs=tr.querySelectorAll('input');
                const select=tr.querySelector('select');
                let dest = ""; let d20 = ""; let d40 = "";
                // Handle different structures (Fresh/Dropdown vs Synced/Input)
                if(select) { dest = select.value; d20 = inputs[1].value; d40 = inputs[2].value; } 
                else { dest = inputs[1].value; d20 = inputs[2].value; d40 = inputs[3].value; }
                
                transport.push({transporter:inputs[0].value,destination:dest,d20:d20,d40:d40,remarks:tr.querySelector('textarea').value})
            });
            document.querySelectorAll('#tbodyIncentive_ap tr').forEach(tr=>{const i=tr.querySelectorAll('input');incentives.push({line:i[0].value,d20:i[1].value,d40:i[2].value,remarks:tr.querySelector('textarea').value})});
        } else {
            document.querySelectorAll('#tbodyTransport tr').forEach(tr=>{const i=tr.querySelectorAll('input');transport.push({transporter:i[0].value,destination:tr.querySelector('select').value,d20:i[1].value,d40:i[2].value,remarks:tr.querySelector('textarea').value})});
            document.querySelectorAll('#tbodyIncentive tr').forEach(tr=>{const i=tr.querySelectorAll('input');incentives.push({line:i[0].value,d20:i[1].value,d40:i[2].value,remarks:tr.querySelector('textarea').value})});
        }

        // --- NEW: Add Approval Tag ---
        // If saving from Main Form (Update Mode), isApproval MUST be false
        // If saving from Approval Mode, isApproval MUST be true
        const isApp = isApprovalMode;

        return {basic,tables,transport,incentives,remarks:{thc:getVal(p+'remTHC'),special:getVal(p+'remSpecial'),add:getVal(p+'remAdd')},customers:customerList,docLink:docLinks.join(', '), isApproval: isApp};
    }

    async function saveDataToSheet(mode = 'auto'){
        // Validation for Approval Mode
        if (isApprovalMode) {
             const isReadOnly = document.getElementById('ap_customerName').disabled;
             if (isReadOnly) {
                 alert("Form is in Read-Only mode.\n\n- Click 'Refresh' to create a NEW Approval Request.\n- Click 'Unlock' (Admins only) to edit this record.");
                 return;
             }
             const requiredMap = {
                 'ap_commodity': 'Commodity',
                 'ap_customerName': 'Customer Name',
                 'ap_customerType': 'Customer Type',
                 'ap_volMonth': 'Vol / Month',
                 'ap_creditDays': 'Credit Days',
                 'ap_salesPerson': 'Sales Person',
                 'ap_billingTerms': 'Billing Terms'
             };
             let missingFields = [];
             for (const [id, label] of Object.entries(requiredMap)) {
                 const el = document.getElementById(id);
                 if (!el || !el.value.trim()) {
                     missingFields.push(label);
                     el.classList.add('border-red-500', 'border-2');
                 } else {
                     el.classList.remove('border-red-500', 'border-2');
                 }
             }
             if (missingFields.length > 0) {
                 alert("Please fill the following Mandatory Fields:\n\n- " + missingFields.join("\n- "));
                 return;
             }
        }
        
        if(!confirm(`Confirm Save?`))return;
        document.getElementById('loadingOverlay').style.display='flex';document.getElementById('loadingOverlay').classList.remove('hidden');
        
        try {
            // --- STRICT SAVE VS UPDATE LOGIC ---
            if (isApprovalMode) {
                if (!editingRecordRef) {
                    const newRef = `AP-${new Date().getFullYear()}${Math.floor(1000+Math.random()*9000)}`;
                    document.getElementById('tariffNo').value = newRef;
                }
            }
            else if (mode === 'update') {
                if (!editingRecordRef) {
                      alert("Error: No record loaded to update. Switching to New Save.");
                      mode = 'new'; 
                } 
            }
            if (mode === 'new' && !isApprovalMode) {
                 const newRef = `TS-${new Date().getFullYear()}${Math.floor(1000+Math.random()*9000)}`;
                 document.getElementById('tariffNo').value = newRef;
                 editingRecordRef = null; 
            }

            const d=captureFullData(),fd=new FormData();
            
            if(isApprovalMode) d.isApproval = true;
            else d.isApproval = false;

            // ACTION DETERMINATION
            if(editingRecordRef){
                fd.append("action","edit");
                fd.append("originalRef",editingRecordRef);
            } else {
                fd.append("action","save");
            }
            
            fd.append("ref",d.basic.ref);
            fd.append("name",d.basic.cust);
            fd.append("date",d.basic.date);
            fd.append("jsonData",JSON.stringify(d));
            fd.append("docLink",d.docLink);
            
            await fetch(CONFIG.SCRIPT_URL,{method:'POST',body:fd,mode:'no-cors'});
            
            let p=0;const i=setInterval(()=>{p+=20;document.getElementById('progressBar').style.width=p+'%';document.getElementById('progressText').innerText=p+'%';if(p>=100){clearInterval(i);
                
                document.getElementById('progressSection').classList.add('hidden');
                document.getElementById('successSection').classList.remove('hidden');
                disableAllInputs(true);
																																											   
			// --- NEW CODE START: Disable Button After Save ---
    		if(isApprovalMode) {
        	const appBtn = document.getElementById('saveAppBtn');
        	appBtn.disabled = true;  // Button click band
        	appBtn.innerText = "SAVED ✓"; // Text change
        	appBtn.classList.remove('animate-pulse', 'hover:bg-green-700'); // Animation hatao
        	appBtn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-600'); // Gray look
    			}
    			// --- NEW CODE END ---																																				                   
                // --- FIX: LOCAL UPDATE TO PREVENT STALE DATA ---
                // Google Cache purana data bhejta hai, isliye hum locally update karenge
                
                const savedRef = d.basic.ref;
                if(!editingRecordRef) editingRecordRef = savedRef;

                // 1. Local List me record dhundho
                let foundIndex = sheetRecords.findIndex(r => r.parsedData.basic.ref === savedRef);
                
                const newRecordObj = {
                    timestamp: new Date().toISOString(),
                    ref: savedRef,
                    name: d.basic.cust,
                    date: d.basic.date,
                    jsonData: JSON.stringify(d),
                    parsedData: d
                };

                if(foundIndex > -1) {
                    // Update existing record locally
                    sheetRecords[foundIndex] = newRecordObj;
                } else {
                    // Add new record locally
                    sheetRecords.push(newRecordObj);
                }
                
                // 2. Dropdowns refresh karo
                sheetRecords.sort((a,b)=>a.name.localeCompare(b.name));
                repopulateDropdowns();

                // 3. User ko usi record par rakho
                const newIndex = sheetRecords.findIndex(r => r.parsedData.basic.ref === savedRef);
                if(newIndex > -1) {
                    if(isApprovalMode) {
                        document.getElementById('approvalHistory').value = newIndex;
                    } else {
                        document.getElementById('cloudHistory').value = newIndex;
                    }
                }

                // DHYAAN DE: Humne fetchSheetData() ko yaha se hata diya hai taaki
                // wo turant purana data la kar humare naye data ko overwrite na kare.
                // Aap baad me manually refresh button daba sakte hain.
                
            }},200);
        }catch(e){alert("Error Saving Data. Check Console.");console.error(e);closeLoading();}
    }

    function closeLoading(){
        document.getElementById('loadingOverlay').style.display='none';
        document.getElementById('loadingOverlay').classList.add('hidden'); // Ensure hidden class is added back
        document.getElementById('progressSection').classList.remove('hidden'); // Reset for next time
        document.getElementById('successSection').classList.add('hidden'); // Hide success message
        document.getElementById('progressBar').style.width='0%'; // Reset progress bar
    }

    // PRE-PARSING OPTIMIZATION: Parse JSON once on fetch
    function fetchSheetData(){
        document.getElementById('syncStatus').innerText="Syncing...";
        window.handleGvizResponse=function(j){
            if(!j||!j.table)return;
            sheetRecords=j.table.rows.map(r=>{
                const c=r.c;
                if(!c||c.length<5)return null;
                const jStr=c[4]?.v||"";
                if(!jStr.startsWith('{')) return null;
                try {
                    const parsed = JSON.parse(jStr);
                    return {
                        timestamp:c[0]?.v,
                        ref:c[1]?.v,
                        name:c[2]?.v,
                        date:c[3]?.f||c[3]?.v,
                        jsonData:jStr,
                        parsedData: parsed // Store pre-parsed data
                    };
                } catch(e) { return null; }
            }).filter(r=>r!==null).sort((a,b)=>a.name.localeCompare(b.name));
            
            // Populate Dropdowns using re-rendering instead of display:none
            repopulateDropdowns();
            
            document.getElementById('syncStatus').innerText=`Total Sheets (${sheetRecords.length})`;
        };
        const s=document.createElement('script');s.src=`https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=responseHandler:handleGvizResponse&tq=SELECT%20A,B,C,D,E`;document.body.appendChild(s);
    }

// Search box ke liye missing function
function filterDropdown() {
    var input = document.getElementById("searchBox");
    repopulateDropdowns(input.value);
}
    function repopulateDropdowns(searchTerm = "") {
        const sel=document.getElementById('cloudHistory');
        const tariffSel=document.getElementById('allTariffHistory');
        const approvalSel=document.getElementById('approvalHistory');
        const mainAppSel = document.getElementById('mainApprovalHistory');
        
        const term = searchTerm.toLowerCase();

        sel.innerHTML='<option>-- All Records --</option>';
        tariffSel.innerHTML='<option>-- Tariffs --</option>';
        approvalSel.innerHTML='<option>-- Pending Approvals --</option>';
        if(mainAppSel) mainAppSel.innerHTML='<option>-- Pending Approvals --</option>';
        
        sheetRecords.forEach((r,i)=>{
            if(term && !r.name.toLowerCase().includes(term)) return;

            // Check logic
            let isApp = (r.parsedData.isApproval === true || r.parsedData.isApproval === "true");
            
            // LOGIC CHANGE HERE:
            if(!isApp) {
                // 1. Agar Approval nahi hai (Normal Record), to Main List me add karo
                const o1=document.createElement('option');o1.value=i;o1.text=r.name;sel.appendChild(o1);

                // 2. AUR isko hi Approval Form ke "Tariffs" dropdown me bhi add karo
                // (Pehle ye line loop ke last me thi, ab yaha andar hai)
                const o2=document.createElement('option');o2.value=i;o2.text=r.name;tariffSel.appendChild(o2);
            } else {
                // Agar Approval hai, to Approval List me add karo
                const o3=document.createElement('option');o3.value=i;o3.text=r.name;approvalSel.appendChild(o3);
                if(mainAppSel) mainAppSel.appendChild(o3.cloneNode(true));
            }
        });
    }
    
    function loadRecordFromDropdown(){loadSelectedRecord(document.getElementById('cloudHistory').value)}
    function loadApprovalRecord(){loadSelectedRecord(document.getElementById('approvalHistory').value)}
    function loadTariffRecord(){loadSelectedRecord(document.getElementById('allTariffHistory').value)}
    function loadMainApprovalRecord(){loadSelectedRecord(document.getElementById('mainApprovalHistory').value)} 
    
    function loadSelectedRecord(i){
        if(i===""||isNaN(i))return;
        // USE PRE-PARSED DATA
        const r=sheetRecords[i];
        const d=r.parsedData;
        
        const tempRef = d.basic.ref;
        resetForm(true);
        
        // Ref ID Set karein
        editingRecordRef = tempRef;
        document.getElementById('tariffNo').value = tempRef;
        
        const set=(id,v)=>{if(document.getElementById(id))document.getElementById(id).value=v;if(document.getElementById('ap_'+id))document.getElementById('ap_'+id).value=v;};
        set('commodity',d.basic.comm);set('customerName',d.basic.cust);set('customerType',d.basic.type);set('volMonth',d.basic.vol);set('creditDays',d.basic.cred);set('salesPerson',d.basic.ver);set('billingTerms',d.basic.bill);set('stream',d.basic.stream);set('remTHC',d.remarks.thc);set('remSpecial',d.remarks.special);set('remAdd',d.remarks.add);
        
        if(d.emailBody) document.getElementById('approvalEmailBody').value = d.emailBody;

        document.getElementById('dateToday').value=d.basic.date;
        document.getElementById('tablesContainer').innerHTML='';tableCounter=0;document.getElementById('ap_tablesContainer').innerHTML='';
        
        // --- TABLES LOAD LOGIC ---
        d.tables.forEach(t=>{
            addNewTableBlock();
            const id=tableCounter;
            document.getElementById(`tt_${id}`).value=t.tt;
            document.getElementById(`sl_${id}`).value=t.sl;
            document.getElementById(`df_${id}`).value=t.df;
            document.getElementById(`dt_${id}`).value=t.dt;
            document.getElementById(`tbl_rem_${id}`).value=t.rem;
            
            if(t.docLink){
                document.getElementById(`docLink_${id}`).value=t.docLink;
                document.getElementById(`previewBtn_${id}`).classList.remove('hidden');
            }
            
            t.rows.forEach((row,x)=>{
                document.getElementById(`t_${id}_pub_${x}`).value=row.pub;
                document.getElementById(`t_${id}_railm_${x}`).value=row.railm;
                document.getElementById(`t_${id}_disc_${x}`).value=row.disc;
                
                // IMPORTANT: Saved SLR value ko load karo
                document.getElementById(`t_${id}_slr_${x}`).value=row.slr;
                
                document.getElementById(`t_${id}_slb_${x}`).value=row.slb;
                document.getElementById(`t_${id}_slw_${x}`).value=row.slw;
                document.getElementById(`t_${id}_slf_${x}`).value=row.slf;
                document.getElementById(`t_${id}_sls_${x}`).value=row.sls;
                document.getElementById(`t_${id}_cha_${x}`).value=row.cha;
                document.getElementById(`t_${id}_fwd_${x}`).value=row.fwd;
                document.getElementById(`t_${id}_sub_${x}`).value=row.sub;
                
                calcTableRow(id,x);
            });
            
            // Logic Update: updateTableValues ko 'true' (preserve) ke sath call karein 
            // taaki ye abhi load kiye gaye SLR data ko overwrite na kare
            updateTableValues(id,true);
        });
        
        document.getElementById('tbodyTransport').innerHTML='';d.transport.forEach(t=>addTransportRow({t:t.transporter,d:t.destination,d20:t.d20,d40:t.d40,rem:t.remarks}));
        document.getElementById('tbodyIncentive').innerHTML='';d.incentives.forEach(i=>addIncentiveRow({l:i.line,d20:i.d20,d40:i.d40,rem:i.remarks}));
        customerList=d.customers||[];renderCustomerList();disableAllInputs(true);
        if(isApprovalMode) syncMainToApproval();

        // Status Logic
        const isPending = d.isApproval === true;
        const isAdmin = ADMIN_USERS.includes(document.getElementById('currentUserDisplay').innerText);

        if (!isApprovalMode) {
            const stat = document.getElementById('mainStatus');
            if(isPending) {
                stat.innerText = "Cost Sheet Pending";
                stat.className = "input-field h-8 flex items-center justify-center font-bold text-[10px] uppercase rounded border text-center status-pending-approval"; 
            } else {
                stat.innerText = "Approved & Valid";
                stat.className = "input-field h-8 flex items-center justify-center font-bold text-[10px] uppercase rounded border text-center status-valid";
            }

            if(isAdmin) {
                document.getElementById('saveBtn').classList.add('hidden');
                document.getElementById('updateBtn').classList.add('hidden');
                document.getElementById('unlockBtn').classList.remove('hidden');
            }
        } else {
            document.getElementById('unlockAppBtn').classList.remove('hidden');
        }
    }
    
    function unlockForm(forApproval = false){
        if(forApproval) {
             // No password for Approval Unlock
             disableAllInputs(false);
             document.getElementById('saveAppBtn').classList.remove('hidden');
             document.getElementById('unlockAppBtn').classList.add('hidden');
             return;
        }
        
        if(prompt("Password:")==="4209211"){
            disableAllInputs(false);
            // for Main Form Unlock
            document.getElementById('unlockBtn').classList.add('hidden');
            document.getElementById('saveBtn').classList.add('hidden'); 
            
            const updBtn = document.getElementById('updateBtn');
            if(updBtn) updBtn.classList.remove('hidden'); 
            
            document.getElementById('addTableBtn').disabled=false;
        } else {
            alert("Incorrect Password!");
        }
    }

    function resetForm(skip){
        if(!skip&&!confirm("Clear Form?"))return;
        editingRecordRef=null;disableAllInputs(false);customerList=[];renderCustomerList();
        document.getElementById('tablesContainer').innerHTML='';document.getElementById('ap_tablesContainer').innerHTML='';tableCounter=0;addNewTableBlock();
        document.getElementById('tbodyTransport').innerHTML='';addTransportRow();
        document.getElementById('tbodyIncentive').innerHTML='';addIncentiveRow();
        document.querySelectorAll('input[type="text"],textarea').forEach(i=>i.value='');
        document.querySelectorAll('select').forEach(s=>{if(!['loginUser','cloudHistory','approvalHistory','allTariffHistory','mainApprovalHistory'].includes(s.id))s.value=""});
        document.getElementById('tariffNo').value=`TS-${new Date().getFullYear()}${Math.floor(1000+Math.random()*9000)}`;document.getElementById('dateToday').valueAsDate=new Date();
        const u=document.getElementById('loginUser').value;if(u){const s=document.getElementById('salesPerson'),as=document.getElementById('ap_salesPerson');if(s)s.value=u;if(as)as.value=u;}
        
        const stat = document.getElementById('mainStatus');
        stat.innerText = "-";
        stat.className = "input-field h-8 flex items-center justify-center font-bold text-[10px] uppercase rounded border text-center status-pending";
        
        if(ADMIN_USERS.includes(document.getElementById('currentUserDisplay').innerText)) {
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('updateBtn').classList.add('hidden');
            document.getElementById('unlockBtn').classList.add('hidden');
            
            document.getElementById('saveAppBtn').classList.remove('hidden');
            document.getElementById('unlockAppBtn').classList.add('hidden');
        }

        if(isApprovalMode) syncMainToApproval();
    }
    
    function downloadApprovalAsImage(){
        const element = document.getElementById('approvalContainer');
        const body = document.body;
        body.classList.add('snapshot-mode');

        const approvalForm = document.getElementById('approvalContainer');
        approvalForm.querySelectorAll('input, select, textarea').forEach(el => {
             if(el.tagName === 'SELECT') {
                 const selText = el.options[el.selectedIndex]?.text || "";
                 el.setAttribute('data-html2canvas-ignore', 'true');
                 const span = document.createElement('span');
                 span.innerText = selText;
                 span.className = "print-replacement font-bold";
                 el.parentNode.insertBefore(span, el);
                 el.style.display = "none";
             } else {
                 el.setAttribute('value', el.value);
                 const val = el.value;
                 el.setAttribute('data-html2canvas-ignore', 'true');
                 const span = document.createElement('span');
                 span.innerText = val;
                 span.className = "print-replacement font-bold text-black";
                 el.parentNode.insertBefore(span, el);
                 el.style.display = "none";
             }
        });

        setTimeout(() => {
            html2canvas(document.body, {
                scale: 3, 
                useCORS: true,
                windowWidth: 1200, 
                ignoreElements: (element) => {
                    return element.id === 'topControls' || element.classList.contains('no-print') || element.classList.contains('sidebar');
                }
            }).then(canvas => {
                body.classList.remove('snapshot-mode');
                
                // Restore Inputs
                approvalForm.querySelectorAll('.print-replacement').forEach(el => el.remove());
                approvalForm.querySelectorAll('input, select, textarea').forEach(el => {
                    el.removeAttribute('data-html2canvas-ignore');
                    el.style.display = "";
                });
                
                const link = document.createElement('a');
                link.download = 'Approval_Request.png';
                link.href = canvas.toDataURL("image/png");
                link.click();

            }).catch(err => {
                body.classList.remove('snapshot-mode');
                approvalForm.querySelectorAll('.print-replacement').forEach(el => el.remove());
                approvalForm.querySelectorAll('input, select, textarea').forEach(el => el.style.display = "");
                console.error(err);
                alert("Failed to generate image: " + err);
            });
        }, 100);
    }

    // --- NEW: HTML Download (Preserves Box Formatting Visually) ---
    function downloadApprovalAsHTML() {
        try {
            const container = document.getElementById('approvalContainer');
            if(!container) { alert("Approval container not found"); return; }
            
            const clone = container.cloneNode(true);
            
            // 1. Process Inputs BEFORE removing anything to maintain index parity
            const origInputs = container.querySelectorAll('input, select, textarea');
            const cloneInputs = clone.querySelectorAll('input, select, textarea');
            
            // Safety check
            if(origInputs.length !== cloneInputs.length) {
                console.warn("Input count mismatch during clone. Attempting fallback.");
            }

            for (let i = 0; i < cloneInputs.length; i++) {
                const copy = cloneInputs[i];
                // Try to match by ID first, then index
                let orig = null;
                if (copy.id) {
                    orig = document.getElementById(copy.id); 
                    // Note: In dynamic rows, IDs are unique, so this works. 
                    // For inputs without IDs (transport row), we fall back to index matching if lengths match
                    if (!orig && i < origInputs.length) orig = origInputs[i];
                } else if (i < origInputs.length) {
                    orig = origInputs[i];
                }

                if (!orig) continue;

                const span = document.createElement('div');
                // Copy classes to maintain layout/width
                span.className = copy.className; 
                // Copy ID to allow specific removals later
                span.id = copy.id;
                
                // Styling to mimic the input box
                Object.assign(span.style, {
                    display: 'flex',
                    alignItems: 'center',
                    minHeight: '22px',
                    whiteSpace: 'pre-wrap',
                    overflow: 'hidden',
                    padding: '2px 4px',
                    border: '1px solid #ccc',
                    backgroundColor: '#fff',
                    color: 'black',
                    fontSize: '11px',
                    fontWeight: 'bold',
                    width: '100%' // Ensure it fills cell
                });
                
                // Specific fix for textarea height
                if(orig.tagName === 'TEXTAREA') {
                    // Check if it's the email template body
                    if(orig.id === 'approvalEmailBody') {
                        // For email body, use the scrollHeight or auto height
                        span.style.minHeight = Math.max(orig.scrollHeight, 128) + 'px';
                        span.style.border = 'none'; // Explicitly no border for email body in HTML output too
                    } else {
                        span.style.minHeight = '60px';
                    }
                    span.style.alignItems = 'flex-start'; // Align text top
                }

                let val = orig.value;
                if(orig.tagName === 'SELECT') {
                     val = orig.options[orig.selectedIndex]?.text || val;
                }
                span.innerText = val;
                
                if(copy.parentNode) copy.parentNode.replaceChild(span, copy);
            }

            // 2. Clean up unwanted elements
            // Remove buttons, hidden elements, and the specific history dropdowns
            // NOTICE: We are NOT removing #approvalCustomerListContainer anymore as requested
            const toRemove = clone.querySelectorAll('button, .hidden:not(#approvalCustomerListContainer), .upload-section-mini, #allTariffHistory, #approvalHistory, #mainApprovalHistory');
            toRemove.forEach(e => e.remove());

            // 3. Generate File
            const htmlContent = `<!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Approval Request - ${document.getElementById('tariffNo').value}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <style>
                    body { background: white; padding: 20px; font-family: 'Segoe UI', sans-serif; max-width: 1400px; margin: 0 auto; color: black; }
                    .app-label { font-weight: 700; font-size: 11px; text-transform: uppercase; color: #000; margin-bottom: 2px; display: block; }
                    table { border-collapse: collapse; width: 100%; margin-bottom: 15px; }
                    td, th { border: 1px solid #666; padding: 4px; font-size: 11px; vertical-align: middle; }
                    .tariff-table th { background: #e5e7eb; color: black; font-weight: bold; text-align: center; }
                    .tariff-table td { text-align: center; }
                    h2 { font-size: 20px; font-weight: 800; color: #1e3a8a; margin-bottom: 15px; border-bottom: 3px solid #1e3a8a; padding-bottom: 5px; }
                    h4 { font-size: 14px; font-weight: bold; margin-bottom: 5px; color: #000; }
                    /* Utility to hide things marked no-print in class list if any remain */
                    .no-print { display: none !important; }
                    /* Ensure grid layouts work */
                    .grid { display: grid; }
                    .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
                    .gap-4 { gap: 1rem; }
                    .mb-4 { margin-bottom: 1rem; }
                    .p-2 { padding: 0.5rem; }
                    .bg-\\[\\#1e293b\\] { background-color: #1e293b; color: white; } /* Header boxes in tariff */
                    /* Force black text on white bg for generated file inputs */
                    .app-input, input, select, textarea { color: black !important; }
                    
                    /* Ensure Customer List is visible in download */
                    #approvalCustomerListContainer { display: block !important; }
                    #approvalCustomerList { display: flex; flex-wrap: wrap; gap: 0.5rem; }
                    #approvalCustomerList li { 
                        padding: 2px 8px; 
                        border: 1px solid #ddd; 
                        border-radius: 4px; 
                        background: #f0f9ff; 
                        font-size: 10px; 
                        display: flex; 
                        align-items: center; 
                        gap: 4px;
                    }
                    #approvalCustomerList li span { font-weight: bold; color: #0ea5e9; }
                </style>
            </head>
            <body>
                ${clone.innerHTML}
            </body>
            </html>`;

            const blob = new Blob([htmlContent], {type: 'text/html'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Approval_Request_${document.getElementById('tariffNo').value}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch(e) {
            console.error("HTML Gen Error:", e);
            alert("Error generating HTML: " + e.message);
        }
    }

    // --- NEW: Excel Download (Structured Data) ---
    function downloadApprovalAsExcel() {
        const wb = XLSX.utils.book_new();
        const data = [];
        
        // Helper to get value
        const val = (id) => {
            const el = document.getElementById(id);
            if(!el) return "";
            if(el.tagName === 'SELECT') return el.options[el.selectedIndex]?.text || "";
            return el.value;
        };

        // Header
        data.push(["NEW APPROVAL REQUEST"]);
        data.push([]); // spacer

        // EMAIL BODY
        data.push(["EMAIL BODY / COVER NOTE"]);
        data.push([val('approvalEmailBody')]);
        data.push([]);

        // Form Grid
        data.push(["Commodity", val('ap_commodity'), "Customer Name", val('ap_customerName')]);
        data.push(["Customer Type", val('ap_customerType'), "Vol / Month", val('ap_volMonth')]);
        data.push(["Credit Days", val('ap_creditDays'), "Sales Person", val('ap_salesPerson')]);
        data.push(["Billing Terms", val('ap_billingTerms'), "Stream", val('ap_stream')]);
        data.push([]);

        // Transport
        data.push(["TRANSPORT TARIFF DETAILS"]);
        data.push(["Transporter", "Origin", "Destination", "Disc 20\"", "Disc 40\"", "Remarks"]);
        document.querySelectorAll('#tbodyTransport_ap tr').forEach(tr => {
            const inputs = tr.querySelectorAll('input');
            const select = tr.querySelector('select');
            const txt = tr.querySelector('textarea');
            let dest = select ? select.value : inputs[1].value;
            let d20 = select ? inputs[1].value : inputs[2].value;
            let d40 = select ? inputs[2].value : inputs[3].value;
            data.push([inputs[0].value, "Kilaraipur", dest, d20, d40, txt.value]);
        });
        data.push([]);

        // Incentive
        data.push(["INCENTIVE DETAILS"]);
        data.push(["Line", "Disc 20\"", "Disc 40\"", "Remarks"]);
        document.querySelectorAll('#tbodyIncentive_ap tr').forEach(tr => {
            const inputs = tr.querySelectorAll('input');
            const txt = tr.querySelector('textarea');
            data.push([inputs[0].value, inputs[1].value, inputs[2].value, txt.value]);
        });
        data.push([]);

        // Remarks
        data.push(["REMARKS"]);
        data.push(["THC Subsidy", val('ap_remTHC')]);
        data.push(["Special Arr.", val('ap_remSpecial')]);
        data.push(["Additional", val('ap_remAdd')]);
        data.push([]);

        // Dynamic Tables
        const tables = document.getElementById('ap_tablesContainer').querySelectorAll('.table-block');
        tables.forEach(tbl => {
            const id = tbl.id.split('_')[1];
            const type = document.getElementById(`tt_${id}`).value;
            const line = document.getElementById(`sl_${id}`).value;
            const valid = document.getElementById(`status_${id}`).innerText;
            
            data.push([`TARIFF TABLE: ${line} - ${type} (${valid})`]);
            data.push(["Slab", "Public", "Rail Mgn", "Disc", "Line R", "Line B", "Line W", "Line F", "Line S", "CHA", "Fwd", "Sub", "Res W", "Res F", "Res S", "Billing"]);
            
            // Reconstruct rows based on slabs logic
            slabs.forEach((s, i) => {
                 const g = (k) => document.getElementById(`t_${id}_${k}_${i}`)?.value || "";
                 const r = (k) => document.getElementById(`t_${id}_${k}_${i}`)?.innerText || "";
                 data.push([
                     s.label, g('pub'), g('railm'), g('disc'), g('slr'), g('slb'), g('slw'), g('slf'), g('sls'), g('cha'), g('fwd'), g('sub'),
                     r('res_w'), r('res_f'), r('res_s'), r('res_t')
                 ]);
            });
            data.push([]);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Basic column widths
        ws['!cols'] = [{wch:20}, {wch:15}, {wch:20}, {wch:15}, {wch:10}, {wch:10}];

        XLSX.utils.book_append_sheet(wb, ws, "Approval Request");
        XLSX.writeFile(wb, `Approval_Request_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
    
    // MOVED TO END: Ensure everything is defined
    document.addEventListener('DOMContentLoaded',()=>{resetForm(true)});
// --- NEW: Main Form HTML Download ---
    function downloadMainAsHTML() {
        try {
            const container = document.getElementById('printArea');
            if(!container) { alert("Print Area not found"); return; }
            
            const clone = container.cloneNode(true);
            
            // 1. Process Inputs (Convert to Text for display)
            const origInputs = container.querySelectorAll('input, select, textarea');
            const cloneInputs = clone.querySelectorAll('input, select, textarea');
            
            for (let i = 0; i < cloneInputs.length; i++) {
                const copy = cloneInputs[i];
                let orig = null;
                
                if (copy.id) {
                    orig = document.getElementById(copy.id); 
                } else if (i < origInputs.length) {
                    orig = origInputs[i];
                }

                if (!orig) continue;

                const span = document.createElement('div');
                span.className = copy.className; 
                span.id = copy.id; // Keep ID
                
                // Copy styles
                Object.assign(span.style, {
                    display: 'flex',
                    alignItems: 'center',
                    minHeight: '22px',
                    whiteSpace: 'pre-wrap',
                    overflow: 'hidden',
                    padding: '2px 4px',
                    border: '1px solid #ccc',
                    // Background color maintain karne ki koshish (e.g. yellow cells)
                    backgroundColor: window.getComputedStyle(orig).backgroundColor, 
                    color: 'black',
                    fontSize: '10px',
                    fontWeight: 'bold',
                    width: '100%' 
                });
                
                if(orig.tagName === 'TEXTAREA') {
                    span.style.minHeight = '50px';
                    span.style.alignItems = 'flex-start';
                }

                let val = orig.value;
                if(orig.tagName === 'SELECT') {
                     val = orig.options[orig.selectedIndex]?.text || val;
                }
                span.innerText = val;
                
                if(copy.parentNode) copy.parentNode.replaceChild(span, copy);
            }

            // 2. Remove unwanted elements (Buttons, Hidden inputs, etc.)
            const toRemove = clone.querySelectorAll('button, .no-print, .upload-section-mini, .hidden');
            toRemove.forEach(e => e.remove());

            // 3. Generate HTML File
            const htmlContent = `<!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Tariff Sheet - ${document.getElementById('tariffNo').value}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <style>
                    body { background: white; padding: 20px; font-family: 'Segoe UI', sans-serif; max-width: 1400px; margin: 0 auto; color: black; }
                    /* Table styling to look like Main Form */
                    .tariff-table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
                    .tariff-table th { border: 1px solid #9ca3af; padding: 6px 2px; background-color: #e5e7eb; color: #000; font-weight: 700; text-align: center; }
                    .tariff-table td { border: 1px solid #9ca3af; padding: 4px 2px; text-align: center; color: #000; }
                    
                    /* Utility classes mapping */
                    .highlight-row { background-color: #f3f4f6; }
                    .bg-yellow-col { background-color: #fff; } 
                    .bg-gray-col { background-color: #f9fafb; font-weight: 700; }
                    .bg-red-col { background-color: #fee2e2; font-weight: 900; }
                    .text-white { color: white !important; }
                    
                    /* Header boxes styling */
                    .grid { display: grid; }
                    .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
                    .gap-4 { gap: 1rem; }
                    .mb-4 { margin-bottom: 1rem; }
                    .p-2 { padding: 0.5rem; }
                    
                    input, select, textarea { color: black !important; font-weight: bold; }
                    h2 { color: #1e3a8a; font-weight: 800; font-size: 1.25rem; }
                </style>
            </head>
            <body>
                <div style="border: 1px solid #ccc; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    ${clone.innerHTML}
                </div>
            </body>
            </html>`;

            const blob = new Blob([htmlContent], {type: 'text/html'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Tariff_${document.getElementById('tariffNo').value}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch(e) {
            console.error("HTML Gen Error:", e);
            alert("Error generating HTML: " + e.message);
        }
    }
</script>
</body>
</html>
